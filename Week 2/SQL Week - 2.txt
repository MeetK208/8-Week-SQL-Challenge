-- A. Pizza Metrics
SET
	SEARCH_PATH = PIZZA_RUNNER;

-- How many pizzas were ordered?
SELECT
	COUNT(PIZZA_ID) AS TOTALPIZZAORDERED
FROM
	CUSTOMER_ORDERS;

-- How many unique customer orders were made?
SELECT
	COUNT(DISTINCT ORDER_ID)
FROM
	CUSTOMER_ORDERS
	-- How many successful orders were delivered by each runner?
SELECT
	RUNNER_ID,
	COUNT(DISTINCT RO.ORDER_ID) ORDERSDELIVERED
FROM
	CUSTOMER_ORDERS CO
	INNER JOIN RUNNER_ORDERS RO ON CO.ORDER_ID = RO.ORDER_ID
WHERE
	CANCELLATION = 'NULL'
GROUP BY
	1
ORDER BY
	1;

-- How many of each type of pizza was delivered?
SELECT
	PIZZA_NAME,
	COUNT(PN.PIZZA_ID)
FROM
	CUSTOMER_ORDERS CO
	INNER JOIN RUNNER_ORDERS RO ON CO.ORDER_ID = RO.ORDER_ID
	INNER JOIN PIZZA_NAMES PN ON CO.PIZZA_ID = PN.PIZZA_ID
WHERE
	DISTANCE_KM != -1
GROUP BY
	1
ORDER BY
	1;

-- How many Vegetarian and Meatlovers were ordered by each customer?
SELECT
	CO.CUSTOMER_ID,
	PIZZA_NAME,
	COUNT(PIZZA_NAME)
FROM
	CUSTOMER_ORDERS CO
	INNER JOIN PIZZA_NAMES PN ON CO.PIZZA_ID = PN.PIZZA_ID
GROUP BY
	1,
	2
ORDER BY
	1;

-- What was the maximum number of pizzas delivered in a single order?
SELECT
	CO.ORDER_ID,
	SUM(
		CASE
			WHEN CANCELLATION = 'NULL' THEN 1
			ELSE 0
		END
	) AS PIZZADELIVERED
FROM
	CUSTOMER_ORDERS CO
	LEFT JOIN RUNNER_ORDERS RO ON CO.ORDER_ID = RO.ORDER_ID
	-- WHERE
	-- 	CANCELLATION = 'NULL'
GROUP BY
	1
ORDER BY
	2 DESC
LIMIT
	1;

-- For each customer, how many delivered pizzas had at least 1 change and how many had no changes?
-- Approach 1
SELECT
	CUSTOMER_ID,
	CASE
		WHEN EXCLUSIONS = '0'
		AND EXTRAS = '0' THEN 'NO'
		ELSE 'YES'
	END AS ISCHANGESEXCLUSION,
	COUNT(CANCELLATION)
FROM
	CUSTOMER_ORDERS CO
	INNER JOIN RUNNER_ORDERS RO ON CO.ORDER_ID = RO.ORDER_ID
WHERE
	CANCELLATION = 'NULL'
GROUP BY
	1,
	2;

-- Approach 2
SELECT
	CUSTOMER_ID,
	COUNT(
		CASE
			WHEN EXCLUSIONS != '0'
			OR EXTRAS != '0' THEN 1
		END
	) AS CHANGED,
	COUNT(
		CASE
			WHEN EXCLUSIONS = '0'
			AND EXTRAS = '0' THEN 1
		END
	) AS UNCHANGED
FROM
	CUSTOMER_ORDERS
GROUP BY
	CUSTOMER_ID
ORDER BY
	CUSTOMER_ID;

-- How many pizzaswere delivered that had both exclusions and extras?
SELECT
	CUSTOMER_ID,
	COUNT(CANCELLATION)
FROM
	CUSTOMER_ORDERS CO
	INNER JOIN RUNNER_ORDERS RO ON CO.ORDER_ID = RO.ORDER_ID
WHERE
	CANCELLATION = 'NULL'
	AND EXCLUSIONS != '0'
	AND EXTRAS != '0'
GROUP BY
	1;

-- What was the total volume of pizzas ordered for each hour of the day?
SELECT
	EXTRACT(
		HOUR
		FROM
			ORDER_TIME
	),
	COUNT(PIZZA_ID)
FROM
	CUSTOMER_ORDERS
GROUP BY
	1
ORDER BY
	1
	-- What was the volume of orders for each day of the week?
SELECT
	TO_CHAR(ORDER_TIME, 'DAY') DAY_OF_WEEK,
	COUNT(PIZZA_ID) PIZZA_COUNT
FROM
	CUSTOMER_ORDERS
GROUP BY
	1 ORDER BY
	1